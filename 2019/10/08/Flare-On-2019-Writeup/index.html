<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Flare-On 2019 Writeup | giglf的盐缸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="写在前面好久没更新，之前立的 toWrite plan几乎全倒了 不过比较好的是，去年flareon2018做了6/12，立了个flag今年要拿牌 现在做到了！！！ 所以必须得来更新一下writeup 其实跟去年的题目比较，感觉今年前面的题目相对比较简单，因此前面做的比较快 最后卡在了最后一题，断断续续做了快20天，心态都快崩了 不过还好，最后还是拿到了牌（虽然现在还没寄到手上 不得不说，flar">
<meta name="keywords" content="flare-on,reverse">
<meta property="og:type" content="article">
<meta property="og:title" content="Flare-On 2019 Writeup">
<meta property="og:url" content="http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/index.html">
<meta property="og:site_name" content="giglf的盐缸">
<meta property="og:description" content="写在前面好久没更新，之前立的 toWrite plan几乎全倒了 不过比较好的是，去年flareon2018做了6/12，立了个flag今年要拿牌 现在做到了！！！ 所以必须得来更新一下writeup 其实跟去年的题目比较，感觉今年前面的题目相对比较简单，因此前面做的比较快 最后卡在了最后一题，断断续续做了快20天，心态都快崩了 不过还好，最后还是拿到了牌（虽然现在还没寄到手上 不得不说，flar">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/5-dx_init.png">
<meta property="og:image" content="http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/5-flag.png">
<meta property="og:image" content="http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/6-exception.png">
<meta property="og:image" content="http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/6-flag.bmp">
<meta property="og:image" content="http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/6-flag2.bmp">
<meta property="og:image" content="http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/7-identify.png">
<meta property="og:image" content="http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/8-getflag.png">
<meta property="og:image" content="http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/8-ppu.png">
<meta property="og:image" content="http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/10-out.gif">
<meta property="og:image" content="http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/10-flag.gif">
<meta property="og:image" content="http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/12-libFunc.png">
<meta property="og:image" content="http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/12-getlibFuncInWindbg.png">
<meta property="og:image" content="http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/12-pkt150.bmp">
<meta property="og:image" content="http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/12-pkt164.bmp">
<meta property="og:image" content="http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/12-pkgtrick.png">
<meta property="og:updated_time" content="2019-10-11T08:46:49.470Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Flare-On 2019 Writeup">
<meta name="twitter:description" content="写在前面好久没更新，之前立的 toWrite plan几乎全倒了 不过比较好的是，去年flareon2018做了6/12，立了个flag今年要拿牌 现在做到了！！！ 所以必须得来更新一下writeup 其实跟去年的题目比较，感觉今年前面的题目相对比较简单，因此前面做的比较快 最后卡在了最后一题，断断续续做了快20天，心态都快崩了 不过还好，最后还是拿到了牌（虽然现在还没寄到手上 不得不说，flar">
<meta name="twitter:image" content="http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/5-dx_init.png">
  
    <link rel="alternative" href="/atom.xml" title="giglf的盐缸" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.jpg">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          rootUrl: '/',
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/head.jpg" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/" title="Hi Mate">giglf</a></h1>
        </hgroup>

        
        <p class="header-subtitle">让咸鱼更咸</p>
        
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">首页</a></li>
                        
                            <li><a href="/archives">文章</a></li>
                        
                            <li><a href="/tags">标签</a></li>
                        
                            <li><a href="/about">about</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl mail" target="_blank" href="mailto:lin.giglf@gmail.com" title="mail">mail</a>
                            
                                <a class="fl github" target="_blank" href="https://github.com/giglf" title="github">github</a>
                            
                                <a class="fl rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/Forensics/" style="font-size: 10px;">Forensics</a> <a href="/tags/Makefile/" style="font-size: 10px;">Makefile</a> <a href="/tags/Misc/" style="font-size: 10px;">Misc</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/apache2/" style="font-size: 10px;">apache2</a> <a href="/tags/flare-on/" style="font-size: 12.5px;">flare-on</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/mi3-td/" style="font-size: 10px;">mi3_td</a> <a href="/tags/mini-lctf/" style="font-size: 10px;">mini-lctf</a> <a href="/tags/minilctf/" style="font-size: 10px;">minilctf</a> <a href="/tags/nasm/" style="font-size: 10px;">nasm</a> <a href="/tags/network-manager/" style="font-size: 10px;">network-manager</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/pwn/" style="font-size: 10px;">pwn</a> <a href="/tags/pwnable-kr/" style="font-size: 10px;">pwnable.kr</a> <a href="/tags/pwnhub/" style="font-size: 10px;">pwnhub</a> <a href="/tags/reverse/" style="font-size: 10px;">reverse</a> <a href="/tags/scheme-v1/" style="font-size: 10px;">scheme v1</a> <a href="/tags/scheme-v2/" style="font-size: 10px;">scheme v2</a> <a href="/tags/so加载/" style="font-size: 10px;">so加载</a> <a href="/tags/unicode/" style="font-size: 10px;">unicode</a> <a href="/tags/utf-8/" style="font-size: 10px;">utf-8</a> <a href="/tags/writeup/" style="font-size: 10px;">writeup</a> <a href="/tags/全国大学生信息安全竞赛初赛/" style="font-size: 12.5px;">全国大学生信息安全竞赛初赛</a> <a href="/tags/内核编译/" style="font-size: 10px;">内核编译</a> <a href="/tags/密码学/" style="font-size: 10px;">密码学</a> <a href="/tags/汇编/" style="font-size: 10px;">汇编</a> <a href="/tags/签名认证/" style="font-size: 12.5px;">签名认证</a> <a href="/tags/编码/" style="font-size: 10px;">编码</a> <a href="/tags/逆向/" style="font-size: 20px;">逆向</a> <a href="/tags/随便写写啦/" style="font-size: 17.5px;">随便写写啦</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/luuman/hexo-theme-spfk">spfk主题</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">我都不知道我是谁了，大概只是一条只想吃吃喝喝的咸鱼吧</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="Me">giglf</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/head.jpg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="Me">giglf</a></h1>
            </hgroup>
            
            <p class="header-subtitle">让咸鱼更咸</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">首页</a></li>
                
                    <li><a href="/archives">文章</a></li>
                
                    <li><a href="/tags">标签</a></li>
                
                    <li><a href="/about">about</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="mail" target="_blank" href="mailto:lin.giglf@gmail.com" title="mail">mail</a>
                    
                        <a class="github" target="_blank" href="https://github.com/giglf" title="github">github</a>
                    
                        <a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-Flare-On-2019-Writeup" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/10/08/Flare-On-2019-Writeup/" class="article-date">
      <time datetime="2019-10-08T09:44:17.000Z" itemprop="datePublished">2019-10-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Flare-On 2019 Writeup
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flare-on/">flare-on</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reverse/">reverse</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>好久没更新，之前立的 toWrite plan几乎全倒了</p>
<p>不过比较好的是，去年flareon2018做了6/12，立了个flag今年要拿牌</p>
<p>现在做到了！！！</p>
<p>所以必须得来更新一下writeup</p>
<p>其实跟去年的题目比较，感觉今年前面的题目相对比较简单，因此前面做的比较快</p>
<p>最后卡在了最后一题，断断续续做了快20天，心态都快崩了</p>
<p>不过还好，最后还是拿到了牌（虽然现在还没寄到手上</p>
<p>不得不说，flareon总是能学到许多</p>
<p>下面开始描述我的解法，在记录完我的解法后，我才会提及到一些题目相关（题目设计、官方解法）</p>
<a id="more"></a>
<h2 id="1-Memecat-Battlestation"><a href="#1-Memecat-Battlestation" class="headerlink" title="1 - Memecat Battlestation"></a>1 - Memecat Battlestation</h2><p>.net直接逆，很简单，xor 一下就出来了</p>
<h2 id="2-Overlong"><a href="#2-Overlong" class="headerlink" title="2 - Overlong"></a>2 - Overlong</h2><p>一段data，程序只循环了0x1c次，把循环patch成0xb0次，则那块数据的长度，得到flag</p>
<h2 id="3-Flarebear"><a href="#3-Flarebear" class="headerlink" title="3 - Flarebear"></a>3 - Flarebear</h2><p>这是一道android题，用kotlin写的apk，直接逆</p>
<p>对小熊有3种操作play, feed, clean</p>
<p>能看到满足一定条件后会调用dancewithflag</p>
<p>总结一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">play</span><br><span class="line">    mass -= 2</span><br><span class="line">    happy += 4</span><br><span class="line">    clean -= 1</span><br><span class="line">feed</span><br><span class="line">    mass += 10</span><br><span class="line">    happy += 2</span><br><span class="line">    clean -= 1</span><br><span class="line">    poo += 0.34</span><br><span class="line">clean</span><br><span class="line">    poo -= 1 if poo &gt; 1</span><br><span class="line">    mass += 0</span><br><span class="line">    happy -= 1</span><br><span class="line">    clean += 6</span><br><span class="line">    setMood</span><br><span class="line"></span><br><span class="line">setMood</span><br><span class="line">    isHappy</span><br><span class="line">    feed/play = [2, 2.5]</span><br><span class="line">        isEcstatic</span><br><span class="line">        mass = 72</span><br><span class="line">        happy = 30</span><br><span class="line">        clean = 0</span><br><span class="line">            call danceWithFlag</span><br></pre></td></tr></table></figure>
<p>得到方程</p>
<p>-2p + 10f = 72</p>
<p>4p + 2f - c = 30</p>
<p>-p - f + 6c = 0</p>
<p>解出，得到flag</p>
<p>p = 4</p>
<p>f = 8</p>
<p>c = 2</p>
<h2 id="4-Dnschess"><a href="#4-Dnschess" class="headerlink" title="4 - Dnschess"></a>4 - Dnschess</h2><p>一个下国际象棋的ai，通过dns协议与server交互</p>
<p>包含有一个pcap数据包</p>
<p>chessAI会把每一步编码成类似<code>pawn-d2-d4.game-of-thrones.flare-on.com</code>的域名，然后通过dns查询得到ip</p>
<p>注意到得到的ip会把数据取出来操作</p>
<p>并得到值放进<a href="mailto:`@flare-on.com" target="_blank" rel="noopener">`@flare-on.com</a>`前面的buffer上，我通过scapy从pcap中提出来ip，模拟一下操作就得到flag了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*-coding:utf-8-*-</span></span><br><span class="line"></span><br><span class="line">result = [<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x66</span>, <span class="number">0x6C</span>, <span class="number">0x61</span>, <span class="number">0x72</span>, <span class="number">0x65</span>, <span class="number">0x2D</span>, <span class="number">0x6F</span>, <span class="number">0x6E</span>, <span class="number">0x2E</span>, <span class="number">0x63</span>, <span class="number">0x6F</span>, <span class="number">0x6D</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>]</span><br><span class="line"></span><br><span class="line">table = [<span class="number">0x79</span>, <span class="number">0x5A</span>, <span class="number">0xB8</span>, <span class="number">0xBC</span>, <span class="number">0xEC</span>, <span class="number">0xD3</span>, <span class="number">0xDF</span>, <span class="number">0xDD</span>, <span class="number">0x99</span>, <span class="number">0xA5</span>, <span class="number">0xB6</span>, <span class="number">0xAC</span>, <span class="number">0x15</span>, <span class="number">0x36</span>, <span class="number">0x85</span>, <span class="number">0x8D</span>, <span class="number">0x09</span>, <span class="number">0x08</span>, <span class="number">0x77</span>, <span class="number">0x52</span>, <span class="number">0x4D</span>, <span class="number">0x71</span>, <span class="number">0x54</span>, <span class="number">0x7D</span>, <span class="number">0xA7</span>, <span class="number">0xA7</span>, <span class="number">0x08</span>, <span class="number">0x16</span>, <span class="number">0xFD</span>, <span class="number">0xD7</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">genResult</span><span class="params">(ip)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> ip[<span class="number">0</span>] != <span class="number">127</span> <span class="keyword">or</span> ip[<span class="number">3</span>] &amp; <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    <span class="keyword">print</span> ip</span><br><span class="line">    a1 = ip[<span class="number">2</span>] &amp; <span class="number">0xf</span></span><br><span class="line">    result[<span class="number">2</span>*a1] = ip[<span class="number">1</span>] ^ table[<span class="number">2</span>*a1]</span><br><span class="line">    result[<span class="number">2</span>*a1+<span class="number">1</span>] = ip[<span class="number">1</span>] ^ table[<span class="number">2</span>*a1+<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getIp_list</span><span class="params">()</span>:</span></span><br><span class="line">    ip_list = []</span><br><span class="line">    pkts = rdpcap(<span class="string">'capture.pcap'</span>)</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> pkts:</span><br><span class="line">        <span class="keyword">if</span> p.haslayer(DNS):</span><br><span class="line">            <span class="keyword">if</span> isinstance(p.an, DNSRR):</span><br><span class="line">               ip = p.an.rdata</span><br><span class="line">               ip_list.append(list(map(int, ip.split(<span class="string">'.'</span>)))) </span><br><span class="line">    <span class="keyword">return</span> ip_list</span><br><span class="line"></span><br><span class="line">ip_list = getIp_list()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> ip_list:</span><br><span class="line">    genResult(ip)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">''</span>.join(map(chr, result))</span><br><span class="line"></span><br><span class="line"><span class="comment"># LooksLikeYouLockedUpTheLookupZ@flare-on.com</span></span><br></pre></td></tr></table></figure>
<h2 id="5-demo"><a href="#5-demo" class="headerlink" title="5 - demo"></a>5 - demo</h2><p>demoscense</p>
<p>一个非常cool的程序，通过代码压缩技术把一段动画压缩到超小的文件（这个甚至还有比赛</p>
<p>这个关系到windows 的 directX，先安装上<code>cinst install directx</code></p>
<p><em>简单吐槽一下，这题主要时间都费在翻directX的文档上了</em></p>
<p>由于该代码加壳了（猜测是个压缩壳</p>
<p>所以得先脱壳才能分析，window嘛，直接调，</p>
<p>start定位到004000d3 retn指令</p>
<p>会直接跳转到0x420000继续进行程序的逻辑</p>
<p>跳转过去后，逻辑什么的都能看到了</p>
<p><img src="/2019/10/08/Flare-On-2019-Writeup/5-dx_init.png" alt="5-dx_init"></p>
<p>在查了半天的DirectX文档后，基本确定，下面两个函数是绘图相关的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(*(*off_430050 + <span class="number">12</span>))(off_430050, <span class="number">0</span>); </span><br><span class="line">(*(*off_430054 + <span class="number">12</span>))(off_430054, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>两个渲染，430050是flare-on的mash</p>
<p>430054是flag的mash</p>
<p>但是现在屏幕上只显示出来flare-on logo的图案，怎么让他把flag现实出来呢？</p>
<p>我一开始觉得，这个原因是flare-on的logo覆盖了flag（类似不透明图层），导致flag不能显示出来</p>
<p>于是我patch掉第一个渲染<code>(*(*off_430050 + 12))(off_430050, 0);</code></p>
<p>发现图案全没了（开始智障之旅= =）</p>
<p>事实证明，我对directX的使用非常不熟悉</p>
<p>在尝试了很久把背景色改透明等等的操作后，我突然想到，为什么我不直接把第一个渲染改成flag的渲染就好了。。。</p>
<p>直接patch program把430050改成430054</p>
<p>得到flag</p>
<p><img src="/2019/10/08/Flare-On-2019-Writeup/5-flag.png" alt="5-flag"></p>
<hr>
<p><strong>PS:</strong> 从这题开始，算是终于进入flareon有意思的部分了，前四题有点水水的</p>
<p>这题官方还给出别的解法</p>
<ol>
<li>通过api trace得到directX调用的顺序，然后可以直接dump出图案的model obj，就可以直接用一些软件直接查看了</li>
<li>代码中渲染了flag的图案，至于为什么不能显示出来，是因为设置了transform，移动了图形的位置，此时flag图案的位置摄像机背后，自然无法显示到界面上</li>
</ol>
<h2 id="6-bmphide"><a href="#6-bmphide" class="headerlink" title="6 - bmphide"></a>6 - bmphide</h2><p>这题上来就又是一个.net</p>
<p><code>bmphide.exe</code>可以把一段数据（可以是文本或任意东西），隐藏到一张bmp图片底下</p>
<p>逆了一段时间，大概看到几个关键点</p>
<ol>
<li>前面调用一个未知函数，里面非常复杂，不知道在干什么，直接看后面</li>
<li>读数据，进行一轮操作变换后，以LSB的方式编码到bmp图片底下</li>
</ol>
<p>LSB的方式如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Color pixel = bm.GetPixel(i, j);</span><br><span class="line">int red = ((int)pixel.R &amp; 248) | ((int)data[num] &amp; 7);</span><br><span class="line">int green = ((int)pixel.G &amp; 248) | (data[num] &gt;&gt; 3 &amp; 7);</span><br><span class="line">int blue = ((int)pixel.B &amp; 252) | (data[num] &gt;&gt; 6 &amp; 3);</span><br><span class="line">Color color = Color.FromArgb(0, red, green, blue);</span><br><span class="line">bm.SetPixel(i, j, color);</span><br></pre></td></tr></table></figure>
<p>那么，就是怎么逆回来的问题了</p>
<p>去调了一下代码</p>
<p>？？？</p>
<p>抛异常了（借用一下官方的图）</p>
<p><img src="/2019/10/08/Flare-On-2019-Writeup/6-exception.png" alt="6-exception"></p>
<p>调了几遍。似乎还是不知道什么原因，只好静态逆了= =</p>
<p>再仔细看了一下，当中的函数，有很大一部分是不用逆的，他们用于生成中间的index值，直接抄就好了</p>
<p>program a, b, c, d, e, f, g -&gt; getByte</p>
<p>program h -&gt; getByteArray</p>
<p>program i -&gt; change input Bitmap</p>
<p>program j -&gt; getInt</p>
<p>于是写了个逆，跑了一下</p>
<p>。。。</p>
<p>。。。</p>
<p>？？？</p>
<p>跑出来是乱码，继续改改，好像没什么问题，但是跑出来为什么是乱码</p>
<p>继续细看</p>
<p>这个时候我注意到一个点，有几个类似数据处理的函数定义了，但是没有被调用</p>
<p>同时这4个函数<code>a, b, c, d</code>，ac被调用了，bd没被调用，但是他们的函数类型（参数类型、返回类型）是一样的</p>
<p>因为在写逆的时候发现函数c其实是不可逆的，那么就可以猜测其实在init那个很复杂的函数里面把ac替换成了bd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">d (b, r): right rotate b, r bits</span><br><span class="line">b (b, r): left rotate b, r bits</span><br></pre></td></tr></table></figure>
<p>回去细看init中根据函数hash搜索部分的代码，验证了我的想法，他就是替换了两个函数的内容！</p>
<p>那么把逆的ac修改成bd后，再跑</p>
<p>。。。</p>
<p>。。。</p>
<p>？？？</p>
<p>还是乱码？？？什么情况</p>
<p>init还有些很奇怪的代码，只能继续看看了</p>
<p>这个时候发现他会调用一些<code>WriteIntPtr</code>、<code>getJit</code>之类的函数，难道他还修改了一些常数？</p>
<p>这个时候还注意到一个点，有个G函数没被调用！他的函数类型跟F是一样的，而F是生成index的关键函数！</p>
<p>看来F也被hook成G了，再结合到getJit上下文，大概就能猜出来修改的是什么常数了</p>
<p>在这里猜的时候，我发现了只要把dnspy一些反反调试机制保护什么的关掉就能调试了，虽然单步好像不太好使，但能让我检验F函数的返回值，的确就是被hook成修改过的G函数了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">programG</span><span class="params">(idx)</span>:</span></span><br><span class="line">    <span class="comment"># b = ((idx + 1) * 3988292384) &amp; 0xff</span></span><br><span class="line">    <span class="comment"># k = ((idx + 2) * 1669101435) &amp; 0xff</span></span><br><span class="line">    b = ((idx + <span class="number">1</span>) * <span class="number">309030853</span>) &amp; <span class="number">0xff</span></span><br><span class="line">    k = ((idx + <span class="number">2</span>) * <span class="number">209897853</span>) &amp; <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">return</span> b ^ k</span><br></pre></td></tr></table></figure>
<p>solve.py （代码其实不算长，就不放github了）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*-coding:utf-8-*-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getCheckSumTable</span><span class="params">()</span>:</span></span><br><span class="line">    ret = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">        num = i</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">            num = (<span class="number">1611621881</span> ^ num &gt;&gt; <span class="number">1</span>) <span class="keyword">if</span> (num &amp; <span class="number">1</span>) != <span class="number">0</span> <span class="keyword">else</span> num &gt;&gt; <span class="number">1</span></span><br><span class="line">        ret.append(num)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">programA</span><span class="params">(b, r)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> (b + r ^ r) &amp; <span class="number">255</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">programB</span><span class="params">(b, r)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(r):</span><br><span class="line">        b2 = (b &amp; <span class="number">128</span>) / <span class="number">128</span></span><br><span class="line">        b = (b * <span class="number">2</span> &amp; <span class="number">0xff</span>) + b2</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">programC</span><span class="params">(b, r)</span>:</span></span><br><span class="line">    b2 = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">        <span class="keyword">if</span> (b &amp; <span class="number">1</span>) == <span class="number">1</span>:</span><br><span class="line">            b2 = (b2 * <span class="number">2</span> + <span class="number">1</span> &amp; <span class="number">0xff</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            b2 = (b2 - <span class="number">1</span> &amp; <span class="number">0xff</span>)</span><br><span class="line">    <span class="keyword">return</span> b2</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">programD</span><span class="params">(b, r)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(r):</span><br><span class="line">        b2 = (b &amp; <span class="number">1</span>) * <span class="number">128</span></span><br><span class="line">        b = (b / <span class="number">2</span> &amp; <span class="number">0xff</span>) + b2</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">programE</span><span class="params">(b, k)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> b ^ k</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">programF</span><span class="params">(idx)</span>:</span></span><br><span class="line">    array = [<span class="number">121</span>, <span class="number">255</span>, <span class="number">214</span>, <span class="number">60</span>, <span class="number">106</span>, <span class="number">216</span>, <span class="number">149</span>, <span class="number">89</span>, <span class="number">96</span>, <span class="number">29</span>, <span class="number">81</span>, <span class="number">123</span>, <span class="number">182</span>, <span class="number">24</span>, <span class="number">167</span>, <span class="number">252</span>, <span class="number">88</span>, <span class="number">212</span>, <span class="number">43</span>, <span class="number">85</span>, <span class="number">181</span>, <span class="number">86</span>, <span class="number">108</span>, <span class="number">213</span>, <span class="number">50</span>, <span class="number">78</span>, <span class="number">247</span>, <span class="number">83</span>, <span class="number">193</span>, <span class="number">35</span>, <span class="number">135</span>, <span class="number">217</span>, <span class="number">0</span>, <span class="number">64</span>, <span class="number">45</span>, <span class="number">236</span>, <span class="number">134</span>, <span class="number">102</span>, <span class="number">76</span>, <span class="number">74</span>, <span class="number">153</span>, <span class="number">34</span>, <span class="number">39</span>, <span class="number">10</span>, <span class="number">192</span>, <span class="number">202</span>, <span class="number">71</span>, <span class="number">183</span>, <span class="number">185</span>, <span class="number">175</span>, <span class="number">84</span>, <span class="number">118</span>, <span class="number">9</span>, <span class="number">158</span>, <span class="number">66</span>, <span class="number">128</span>, <span class="number">116</span>, <span class="number">117</span>, <span class="number">4</span>, <span class="number">13</span>, <span class="number">46</span>, <span class="number">227</span>, <span class="number">132</span>, <span class="number">240</span>, <span class="number">122</span>, <span class="number">11</span>, <span class="number">18</span>, <span class="number">186</span>, <span class="number">30</span>, <span class="number">157</span>, <span class="number">1</span>, <span class="number">154</span>, <span class="number">144</span>, <span class="number">124</span>, <span class="number">152</span>, <span class="number">187</span>, <span class="number">32</span>, <span class="number">87</span>, <span class="number">141</span>, <span class="number">103</span>, <span class="number">189</span>, <span class="number">12</span>, <span class="number">53</span>, <span class="number">222</span>, <span class="number">206</span>, <span class="number">91</span>, <span class="number">20</span>, <span class="number">174</span>, <span class="number">49</span>, <span class="number">223</span>, <span class="number">155</span>, <span class="number">250</span>, <span class="number">95</span>, <span class="number">31</span>, <span class="number">98</span>, <span class="number">151</span>, <span class="number">179</span>, <span class="number">101</span>, <span class="number">47</span>, <span class="number">17</span>, <span class="number">207</span>, <span class="number">142</span>, <span class="number">199</span>, <span class="number">3</span>, <span class="number">205</span>, <span class="number">163</span>, <span class="number">146</span>, <span class="number">48</span>, <span class="number">165</span>, <span class="number">225</span>, <span class="number">62</span>, <span class="number">33</span>, <span class="number">119</span>, <span class="number">52</span>, <span class="number">241</span>, <span class="number">228</span>, <span class="number">162</span>, <span class="number">90</span>, <span class="number">140</span>, <span class="number">232</span>, <span class="number">129</span>, <span class="number">114</span>, <span class="number">75</span>, <span class="number">82</span>, <span class="number">190</span>, <span class="number">65</span>, <span class="number">2</span>, <span class="number">21</span>, <span class="number">14</span>, <span class="number">111</span>, <span class="number">115</span>, <span class="number">36</span>, <span class="number">107</span>, <span class="number">67</span>, <span class="number">126</span>, <span class="number">80</span>, <span class="number">110</span>, <span class="number">23</span>, <span class="number">44</span>, <span class="number">226</span>, <span class="number">56</span>, <span class="number">7</span>, <span class="number">172</span>, <span class="number">221</span>, <span class="number">239</span>, <span class="number">161</span>, <span class="number">61</span>, <span class="number">93</span>, <span class="number">94</span>, <span class="number">99</span>, <span class="number">171</span>, <span class="number">97</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">28</span>, <span class="number">166</span>, <span class="number">209</span>, <span class="number">229</span>, <span class="number">136</span>, <span class="number">130</span>, <span class="number">164</span>, <span class="number">194</span>, <span class="number">243</span>, <span class="number">220</span>, <span class="number">25</span>, <span class="number">169</span>, <span class="number">105</span>, <span class="number">238</span>, <span class="number">245</span>, <span class="number">215</span>, <span class="number">195</span>, <span class="number">203</span>, <span class="number">170</span>, <span class="number">16</span>, <span class="number">109</span>, <span class="number">176</span>, <span class="number">27</span>, <span class="number">184</span>, <span class="number">148</span>, <span class="number">131</span>, <span class="number">210</span>, <span class="number">231</span>, <span class="number">125</span>, <span class="number">177</span>, <span class="number">26</span>, <span class="number">246</span>, <span class="number">127</span>, <span class="number">198</span>, <span class="number">254</span>, <span class="number">6</span>, <span class="number">69</span>, <span class="number">237</span>, <span class="number">197</span>, <span class="number">54</span>, <span class="number">59</span>, <span class="number">137</span>, <span class="number">79</span>, <span class="number">178</span>, <span class="number">139</span>, <span class="number">235</span>, <span class="number">249</span>, <span class="number">230</span>, <span class="number">233</span>, <span class="number">204</span>, <span class="number">196</span>, <span class="number">113</span>, <span class="number">120</span>, <span class="number">173</span>, <span class="number">224</span>, <span class="number">55</span>, <span class="number">92</span>, <span class="number">211</span>, <span class="number">112</span>, <span class="number">219</span>, <span class="number">208</span>, <span class="number">77</span>, <span class="number">191</span>, <span class="number">242</span>, <span class="number">133</span>, <span class="number">244</span>, <span class="number">168</span>, <span class="number">188</span>, <span class="number">138</span>, <span class="number">251</span>, <span class="number">70</span>, <span class="number">150</span>, <span class="number">145</span>, <span class="number">248</span>, <span class="number">180</span>, <span class="number">218</span>, <span class="number">42</span>, <span class="number">15</span>, <span class="number">159</span>, <span class="number">104</span>, <span class="number">22</span>, <span class="number">37</span>, <span class="number">72</span>, <span class="number">63</span>, <span class="number">234</span>, <span class="number">147</span>, <span class="number">200</span>, <span class="number">253</span>, <span class="number">100</span>, <span class="number">19</span>, <span class="number">73</span>, <span class="number">5</span>, <span class="number">57</span>, <span class="number">201</span>, <span class="number">51</span>, <span class="number">156</span>, <span class="number">41</span>, <span class="number">143</span>, <span class="number">68</span>, <span class="number">8</span>, <span class="number">160</span>, <span class="number">58</span>]</span><br><span class="line">    </span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    num2 = <span class="number">0</span></span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(idx+<span class="number">1</span>):</span><br><span class="line">        num += <span class="number">1</span></span><br><span class="line">        num %= <span class="number">256</span></span><br><span class="line">        num2 += array[num]</span><br><span class="line">        num2 %= <span class="number">256</span></span><br><span class="line">        array[num], array[num2] = array[num2], array[num]</span><br><span class="line">        result = array[(array[num] + array[num2]) % <span class="number">256</span>]</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">programG</span><span class="params">(idx)</span>:</span></span><br><span class="line">    <span class="comment"># b = ((idx + 1) * 3988292384) &amp; 0xff</span></span><br><span class="line">    <span class="comment"># k = ((idx + 2) * 1669101435) &amp; 0xff</span></span><br><span class="line">    b = ((idx + <span class="number">1</span>) * <span class="number">309030853</span>) &amp; <span class="number">0xff</span></span><br><span class="line">    k = ((idx + <span class="number">2</span>) * <span class="number">209897853</span>) &amp; <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">return</span> b ^ k</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">programH</span><span class="params">(in_data)</span>:</span></span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    ret = [<span class="number">0</span>] * len(in_data)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(in_data)):</span><br><span class="line">        num2 = programG(num)</span><br><span class="line">        num += <span class="number">1</span></span><br><span class="line">        num3 = in_data[i]</span><br><span class="line">        num3 = programE(num3, num2)</span><br><span class="line">        num3 = programB(num3, <span class="number">7</span>)</span><br><span class="line">        </span><br><span class="line">        num4 = programG(num)</span><br><span class="line">        num += <span class="number">1</span></span><br><span class="line">        num3 = programE(num3, num4)</span><br><span class="line">        num3 = programD(num3, <span class="number">3</span>)</span><br><span class="line">        ret[i] = num3</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">programJ</span><span class="params">(z)</span>:</span></span><br><span class="line">    b = <span class="number">5</span></span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    value = <span class="string">''</span></span><br><span class="line">    bytes_v = <span class="string">''</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">if</span> b == <span class="number">1</span>:</span><br><span class="line">            num += <span class="number">4</span></span><br><span class="line">            b += <span class="number">2</span></span><br><span class="line">        <span class="keyword">elif</span> b == <span class="number">2</span>:</span><br><span class="line">            num = num * <span class="number">2738</span></span><br><span class="line">            b += <span class="number">8</span></span><br><span class="line">        <span class="keyword">elif</span> b == <span class="number">3</span>:</span><br><span class="line">            num += programF(<span class="number">6</span>)</span><br><span class="line">            b += <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> b == <span class="number">4</span>:</span><br><span class="line">            z = programB(z, <span class="number">1</span>)</span><br><span class="line">            b += <span class="number">2</span></span><br><span class="line">        <span class="keyword">elif</span> b == <span class="number">5</span>:</span><br><span class="line">            num = int(<span class="string">'1F7D1482'</span>, <span class="number">16</span>)</span><br><span class="line">            b -= <span class="number">3</span></span><br><span class="line">        <span class="keyword">elif</span> b == <span class="number">6</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">elif</span> b == <span class="number">7</span>:</span><br><span class="line">            num += int(value)</span><br><span class="line">            b -= <span class="number">6</span></span><br><span class="line">        <span class="keyword">elif</span> b == <span class="number">10</span>:</span><br><span class="line">            bytes_v = <span class="string">'MzQxOTk='</span>.decode(<span class="string">'base64'</span>)</span><br><span class="line">            b += <span class="number">4</span></span><br><span class="line">        <span class="keyword">elif</span> b == <span class="number">14</span>:</span><br><span class="line">            value = bytes_v</span><br><span class="line">            b -= <span class="number">7</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (z ^ num) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extractData</span><span class="params">()</span>:</span></span><br><span class="line">    img = Image.open(<span class="string">'flag.bmp'</span>).convert(<span class="string">'RGB'</span>)</span><br><span class="line">    data = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(img.width):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(img.height):</span><br><span class="line">            r, g, b = img.getpixel((i, j))</span><br><span class="line">            num = (r &amp; <span class="number">7</span>) | ((g &amp; <span class="number">7</span>) &lt;&lt; <span class="number">3</span>) | ((b &amp; <span class="number">3</span>) &lt;&lt; <span class="number">6</span>) </span><br><span class="line">            data.append(num)</span><br><span class="line">    </span><br><span class="line">    r, g, b = img.getpixel((<span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">    num = (r &amp; <span class="number">7</span>) | ((g &amp; <span class="number">7</span>) &lt;&lt; <span class="number">3</span>) | ((b &amp; <span class="number">3</span>) &lt;&lt; <span class="number">6</span>)</span><br><span class="line">    <span class="keyword">print</span> num</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dataDeTranslate</span><span class="params">(data)</span>:</span></span><br><span class="line">    result = []</span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> data:</span><br><span class="line">        num2 = programG(num)</span><br><span class="line">        num += <span class="number">1</span></span><br><span class="line">        num4 = programG(num)</span><br><span class="line">        num += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        num3 = d</span><br><span class="line">        num3 = programB(num3, <span class="number">3</span>)</span><br><span class="line">        num3 ^= num4</span><br><span class="line">        num3 = programD(num3, <span class="number">7</span>)</span><br><span class="line">        num3 ^= num2</span><br><span class="line">        result.append(num3 &amp; <span class="number">0xff</span>)</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'flag2.bmp'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">''</span>.join(map(chr, result)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data = extractData()</span><br><span class="line">dataDeTranslate(data)</span><br></pre></td></tr></table></figure>
<p>处理运行得到flag.bmp</p>
<p>还是一张普通的图，再把flag.bmp输入得到flag2.bmp，得到真正的flag</p>
<p><img src="/2019/10/08/Flare-On-2019-Writeup/6-flag.bmp" alt="6-flag"></p>
<p><img src="/2019/10/08/Flare-On-2019-Writeup/6-flag2.bmp" alt="6-flag2"></p>
<hr>
<p><strong>PS:</strong> 这题算是.net的骚操作了，对.net完全不熟，真的脑壳疼，全程靠猜</p>
<p>至于为什么不能调试，这其实又是.net的一个骚操作</p>
<p>根据官方writeup，这是一个anti-debug，没太看懂是什么原理，似乎他是会把getJit hook加上IncrementMaxStack，但是还是没懂为什么就抛异常了</p>
<p>然后把dnspy的反反调试去掉就又好了</p>
<p>官方的一种解法很值得我们学习：</p>
<p><strong>Black Box Analysis</strong></p>
<p>通过对黑盒输入空白图片，统计输出规律，进行暴力破解还原隐藏的byte</p>
<p>详细方法可参考官方题解</p>
<p><a href="https://www.fireeye.com/content/dam/fireeye-www/blog/pdfs/FlareOn6_Challenge6_Solution_BMPHIDE.pdf" target="_blank" rel="noopener">https://www.fireeye.com/content/dam/fireeye-www/blog/pdfs/FlareOn6_Challenge6_Solution_BMPHIDE.pdf</a></p>
<p>官方的另一种解法就是通过写逆了</p>
<h2 id="7-wopr"><a href="#7-wopr" class="headerlink" title="7 - wopr"></a>7 - wopr</h2><p>这题乍一看不知道什么鬼，但其实看一下搜到的strings就能发现许多python相关的字符串</p>
<p>可以推断出用的pyinstaller打的包</p>
<p>通过<a href="https://github.com/countercept/python-exe-unpacker提取出pyc" target="_blank" rel="noopener">https://github.com/countercept/python-exe-unpacker提取出pyc</a></p>
<p>提取出来要注意这是python3的pyc，有些pyc缺少了文件头，需要自己加上，有些不用，不然用uncompyle6不能反编译</p>
<p>但是extract出来一大堆文件，里面还包含不少库文件，怎么定位到到底是哪个文件呢？这个提取出来不像别的包含跟exe同名的script</p>
<p>我用的方法非常简单，跑起来，ctrl+c</p>
<p><img src="/2019/10/08/Flare-On-2019-Writeup/7-identify.png" alt="7-identify"></p>
<p>然后给cleanup加上pyc header，这里注意python的版本，在extract的时候可以得到</p>
<p><code>header = [0x42, 0x0d, 0x0d, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]</code></p>
<p>他会通过</p>
<p><code>code = lzma.decompress(fire(eye(__doc__.encode()), *bytes*([i]) + BOUNCE))</code></p>
<p>提取出隐藏的代码。里面许多函数不需要逆，直接cv了用就好</p>
<p>但这里直接跑是拿不到code的</p>
<p>注意<code>__doc__.encode()</code>，从doc里拿到的全是空格，怎么可能包含数据，这种tricks以前就遇到过了，用tab+space的组合隐藏数据，直接查看pyc的确能看到一大堆tab+space组合的数据，看来是uncompyle6把数据抹掉了</p>
<p>直接提出来就拿到真实跑的代码了</p>
<p>然后就能发现一堆约束，直接用z3解就完事了</p>
<p>其中一个关键的key是binary的代码段md5，要先计算出reloc固定的偏移，原代码中是直接搜索本进程的内存，想要直接沿用代码，必须注入进去，这步似乎挺麻烦的，因为我直接理解后手动计算了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*-coding:utf-8-*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">patchText</span><span class="params">(data, reloc, base)</span>:</span></span><br><span class="line">    e = <span class="number">0</span></span><br><span class="line">    textvaddr = <span class="number">0x1000</span></span><br><span class="line">    <span class="comment"># cal = 0</span></span><br><span class="line">    <span class="keyword">while</span> e &lt;= len(reloc) - <span class="number">8</span>:</span><br><span class="line">        addr, size = struct.unpack_from(<span class="string">'=II'</span>, reloc, e)</span><br><span class="line">        <span class="keyword">if</span> addr == <span class="number">0</span> <span class="keyword">and</span> size == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        slot = reloc[e+<span class="number">8</span>: e+size]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(slot) &gt;&gt; <span class="number">1</span>):</span><br><span class="line">            <span class="comment"># print 'solt: ' + str(i)</span></span><br><span class="line">            value, = struct.unpack_from(<span class="string">'=H'</span>, slot, <span class="number">2</span>*i)</span><br><span class="line">            f = value &gt;&gt; <span class="number">12</span></span><br><span class="line">            <span class="keyword">if</span> f != <span class="number">3</span>: <span class="keyword">continue</span></span><br><span class="line">            value = value &amp; <span class="number">0xfff</span></span><br><span class="line">            ready = addr + value - textvaddr</span><br><span class="line">            <span class="keyword">if</span> <span class="number">0</span> &lt;= ready &lt; len(data):</span><br><span class="line">                <span class="comment"># numstr = (struct.unpack_from('=I', data, ready)[0] - base)</span></span><br><span class="line">                <span class="comment"># print hex(ready) + ' ' + hex(numstr)</span></span><br><span class="line">                <span class="comment"># print hex(ready)</span></span><br><span class="line">                <span class="comment"># data = data[:ready] + struct.pack('=I', numstr) + data[ready+4:]</span></span><br><span class="line">                struct.pack_into(<span class="string">'=I'</span>, data, ready, (struct.unpack_from(<span class="string">'=I'</span>, data, ready)[<span class="number">0</span>] - base))</span><br><span class="line"></span><br><span class="line">        e += size</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getH</span><span class="params">()</span>:</span></span><br><span class="line">    data = open(<span class="string">'7 - wopr/wopr.exe'</span>, <span class="string">'rb'</span>).read()</span><br><span class="line">    textdata = data[<span class="number">0x400</span>:<span class="number">0x400</span>+<span class="number">0x1f224</span>]</span><br><span class="line">    reloc = data[<span class="number">0x49a00</span>:<span class="number">0x49a00</span>+<span class="number">0x17b8</span>]</span><br><span class="line">    data = patchText(bytearray(textdata), bytearray(reloc), <span class="number">0x400000</span>)</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(data).digest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solve</span><span class="params">(h)</span>:</span></span><br><span class="line">    x = [BitVec(<span class="string">'x'</span>+str(i), <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>)]</span><br><span class="line">    s = Solver()</span><br><span class="line">    s.add(h[<span class="number">0</span>] == x[<span class="number">2</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">14</span>])</span><br><span class="line">    s.add(h[<span class="number">1</span>] == x[<span class="number">0</span>] ^ x[<span class="number">1</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>])</span><br><span class="line">    s.add(h[<span class="number">2</span>] == x[<span class="number">0</span>] ^ x[<span class="number">1</span>] ^ x[<span class="number">2</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">5</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">9</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">    s.add(h[<span class="number">3</span>] == x[<span class="number">5</span>] ^ x[<span class="number">6</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">9</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">    s.add(h[<span class="number">4</span>] == x[<span class="number">1</span>] ^ x[<span class="number">6</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">    s.add(h[<span class="number">5</span>] == x[<span class="number">0</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">9</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">    s.add(h[<span class="number">6</span>] == x[<span class="number">1</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">9</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">    s.add(h[<span class="number">7</span>] == x[<span class="number">0</span>] ^ x[<span class="number">1</span>] ^ x[<span class="number">2</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">14</span>])</span><br><span class="line">    s.add(h[<span class="number">8</span>] == x[<span class="number">1</span>] ^ x[<span class="number">2</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">5</span>] ^ x[<span class="number">9</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">12</span>])</span><br><span class="line">    s.add(h[<span class="number">9</span>] == x[<span class="number">6</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">    s.add(h[<span class="number">10</span>] == x[<span class="number">0</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">8</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">    s.add(h[<span class="number">11</span>] == x[<span class="number">0</span>] ^ x[<span class="number">2</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">6</span>] ^ x[<span class="number">13</span>])</span><br><span class="line">    s.add(h[<span class="number">12</span>] == x[<span class="number">0</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">6</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">    s.add(h[<span class="number">13</span>] == x[<span class="number">2</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">4</span>] ^ x[<span class="number">5</span>] ^ x[<span class="number">6</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">12</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>])</span><br><span class="line">    s.add(h[<span class="number">14</span>] == x[<span class="number">1</span>] ^ x[<span class="number">2</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">5</span>] ^ x[<span class="number">7</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">14</span>] ^ x[<span class="number">15</span>])</span><br><span class="line">    s.add(h[<span class="number">15</span>] == x[<span class="number">1</span>] ^ x[<span class="number">3</span>] ^ x[<span class="number">5</span>] ^ x[<span class="number">9</span>] ^ x[<span class="number">10</span>] ^ x[<span class="number">11</span>] ^ x[<span class="number">13</span>] ^ x[<span class="number">15</span>])</span><br><span class="line"></span><br><span class="line">    s.check()</span><br><span class="line">    result = s.model()</span><br><span class="line">    <span class="keyword">return</span> [result.get_interp(x[i]).as_long() <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>)]</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fire</span><span class="params">(wood, bounce)</span>:</span></span><br><span class="line">    meaning = bytearray(wood)</span><br><span class="line">    bounce = bytearray(bounce)</span><br><span class="line">    regard = len(bounce)</span><br><span class="line">    manage = list(range(<span class="number">256</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prospect</span><span class="params">(*financial)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> sum(financial) % <span class="number">256</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">blade</span><span class="params">(feel, cassette)</span>:</span></span><br><span class="line">        cassette = prospect(cassette, manage[feel])</span><br><span class="line">        manage[feel], manage[cassette] = manage[cassette], manage[feel]</span><br><span class="line">        <span class="keyword">return</span> cassette</span><br><span class="line"></span><br><span class="line">    cassette = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> feel <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">        cassette = prospect(cassette, bounce[(feel % regard)])</span><br><span class="line">        cassette = blade(feel, cassette)</span><br><span class="line"></span><br><span class="line">    cassette = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> pigeon, _ <span class="keyword">in</span> enumerate(meaning):</span><br><span class="line">        feel = prospect(pigeon, <span class="number">1</span>)</span><br><span class="line">        cassette = blade(feel, cassette)</span><br><span class="line">        meaning[pigeon] ^= manage[prospect(manage[feel], manage[cassette])]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bytes(meaning)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getFlag</span><span class="params">(x)</span>:</span></span><br><span class="line">    eye = [<span class="number">219</span>, <span class="number">232</span>, <span class="number">81</span>, <span class="number">150</span>, <span class="number">126</span>, <span class="number">54</span>, <span class="number">116</span>, <span class="number">129</span>, <span class="number">3</span>, <span class="number">61</span>, <span class="number">204</span>, <span class="number">119</span>, <span class="number">252</span>, <span class="number">122</span>, <span class="number">3</span>, <span class="number">209</span>, <span class="number">196</span>, <span class="number">15</span>, <span class="number">148</span>, <span class="number">173</span>, <span class="number">206</span>, <span class="number">246</span>, <span class="number">242</span>, <span class="number">200</span>, <span class="number">201</span>, <span class="number">167</span>, <span class="number">2</span>, <span class="number">102</span>, <span class="number">59</span>, <span class="number">122</span>, <span class="number">81</span>, <span class="number">6</span>, <span class="number">24</span>, <span class="number">23</span>]</span><br><span class="line">    flag = fire(eye, x).decode()</span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    xor = [<span class="number">212</span>, <span class="number">162</span>, <span class="number">242</span>, <span class="number">218</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">50</span>, <span class="number">31</span>, <span class="number">125</span>, <span class="number">112</span>, <span class="number">249</span>, <span class="number">83</span>, <span class="number">55</span>, <span class="number">187</span>, <span class="number">131</span>, <span class="number">206</span>]</span><br><span class="line">    h = getH()</span><br><span class="line">    h = [ord(h[i]) ^ xor[i] <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>)]</span><br><span class="line">    x = solve(h)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">''</span>.join(map(chr, x))</span><br><span class="line">    <span class="keyword">print</span> getFlag(x)</span><br></pre></td></tr></table></figure>
<p><strong>PS：</strong>这题官方的解法中规中矩，没有太特别的地方</p>
<p>看了一下别人的解法，是直接dump memory修改了一下代码直接用的</p>
<p>flag是 <a href="mailto:L1n34R_4L93bR4_i5_FuN@flare-on.com" target="_blank" rel="noopener">L1n34R_4L93bR4_i5_FuN@flare-on.com</a></p>
<p>emmm？linear algebra？ 🙃</p>
<h2 id="8-snake"><a href="#8-snake" class="headerlink" title="8 - snake"></a>8 - snake</h2><p>居然是个nes的镜像</p>
<p>找了一些资料</p>
<p><a href="http://wiki.nesdev.com/w/index.php/Bad_Apple" target="_blank" rel="noopener">http://wiki.nesdev.com/w/index.php/Bad_Apple</a></p>
<p><a href="http://wiki.nesdev.com/w/index.php/Emulators" target="_blank" rel="noopener">http://wiki.nesdev.com/w/index.php/Emulators</a></p>
<p>然后选择了一款看着挺好用的模拟器</p>
<p>FCEUX emulator</p>
<p>有点像cheat Engine的做法</p>
<p>可以在内存中搜索值，然后可以定位到吃苹果的个数，也就是分数值</p>
<p>在那个内存设定break in read</p>
<p>就可以在吃到苹果的一刻断下，查看附近代码，能看到两个关键点</p>
<p>cmp 0x33 和 cmp 0x4</p>
<p>然后修改内存后，flag就出来了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x0025: 吃的苹果个数        0x33时进行下一关</span><br><span class="line">0x0027: 当前速度（关卡？）   0x04时...flag出来了</span><br></pre></td></tr></table></figure>
<p><img src="/2019/10/08/Flare-On-2019-Writeup/8-getflag.png" alt="8-getflag"></p>
<p><strong>PS:</strong>这题是真的很简单呀</p>
<p>在twitter上看到有人真的靠玩出来的😂 tqltql</p>
<p>官方还提到一种做法，是跟NES的PPU data相关的</p>
<p>Nes把图案显示到屏幕，是通过把像下面的title map写到PPU Name Table上的</p>
<p>map的时候，按下面Normal title map，0-9A-Z应该是对应着从数字0数到35，但是通过模拟器的PPU viewer，可以看到他被打乱的，同时通过调试可以看到他还做了一些小混淆，计算显示时把data-0x10，所以通过这种方法恢复后，就可以直接从binary中搜到flag了</p>
<p><img src="/2019/10/08/Flare-On-2019-Writeup/8-ppu.png" alt="8-ppu"></p>
<h2 id="9-reloadered"><a href="#9-reloadered" class="headerlink" title="9 - reloadered"></a>9 - reloadered</h2><p>main逻辑很简单，但是还原不出来flag</p>
<p>拿其中一个有效flag输入是显示错误的（wrong key），但是在调试的时候则显示正确</p>
<p>message提到</p>
<blockquote>
<p> I hear that it caused problems when trying to analyze it with ghidra.</p>
</blockquote>
<p>似乎用ghidra分析会报异常？</p>
<p>不过用ida没事</p>
<p>并且用OD调试的时候，发现在原main逻辑代码底下有另外一套相似的代码，也包含wrong key</p>
<p>看来，程序应该是做了一些有趣的骚操作</p>
<p>尝试了几次，发现了一个东西，就是我反复执行的时候，有时候显示的UI界面不一样！</p>
<p>有时包含logo，有时只有单独一行字符</p>
<p>尝试了一下，捉摸不到显示的规律，结合ida分析，一开始分析的代码应该是包含logo的那个</p>
<p>不知道是什么原理，直接在ida中搜索找不到相关的代码</p>
<p>检查了一下md5，binary是一直没有任何修改的</p>
<p>换种调试方法</p>
<p>直接启动后，通过attach上去调试</p>
<p>发现其rebase到0x0010000的位置</p>
<p>在0x112D0发现奇怪的代码，里面还包含了GetModuleHandleA(0)的函数</p>
<p>大致看了一下是直接在进程了修改了相关代码，运行完以后直接就一大片nop掉了</p>
<p>前面还看到了反调试的代码，还有很多不知道什么check，但是不重要，因为我们已经拿到代码了</p>
<p>代码非常简单，跟前面的逻辑差不多</p>
<p>直接就能解出来flag了</p>
<hr>
<p><strong>PS:</strong> 89这两题，感觉就有点过于简单了</p>
<p>但是对于这题，背后实现原理远比解题要有意思</p>
<p>为什么会显示不同的逻辑？</p>
<p>首先，正常逻辑包含有几部分的代码</p>
<p>anti-vm, anti-debug, decoding, testing the password</p>
<p>而关键位置anti-vm部分是通过时间检测实现的，这是个非常玄的检测方式，这也就说明了直接跑为什么有时会显示正常逻辑，有时候会显示假逻辑</p>
<p>但是直接从start分析也没那么好分析</p>
<p>隐藏函数在0x112d0的偏移，但是跳转过去会查看到一大片nop</p>
<p>官方wp没有详细说明这个函数是怎么生成的</p>
<p>似乎是跟base relocation table有关？</p>
<p>事实是，这跟PE的加载机制有关，这片代码不是从start的地方生成的，只要binary加载到内存上就会生成这片代码</p>
<p>具体查看<a href="https://corkamiwiki.github.io/PE#relocations" target="_blank" rel="noopener">https://corkamiwiki.github.io/PE#relocations</a></p>
<p>文档也给出了实现代码<a href="https://github.com/angea/corkami/blob/master/src/PE/reloccrypt.asm" target="_blank" rel="noopener">https://github.com/angea/corkami/blob/master/src/PE/reloccrypt.asm</a></p>
<p>看了一下，没太看懂= =，这应该算是一种基于PE loader操作的加密方式</p>
<h2 id="10-Mugatu"><a href="#10-Mugatu" class="headerlink" title="10 - Mugatu"></a>10 - Mugatu</h2><p>这题一开始分析的时候看得我一头雾水，各种api乱调用的感觉</p>
<p>行吧，调试看看，结果一调试发现，实际的import table跟显示出来的不一样！</p>
<p>看来是做了些混淆</p>
<p>对PE不熟悉，手动根据调试信息恢复了一下导入表，总算能正常静态分析了</p>
<p>首先，这是一个勒索病毒，会把gif图片加密</p>
<p>但是直接分析没什么特别的头绪，程序从资源中加载了两张图片，分别为G和F</p>
<p>那么这两张什么图片呢？</p>
<p>直接debug跟踪了一下，把图片数据dump了出来，发现。。。F在用BitBlt的xor处理完后是个dll</p>
<p>总结一下是这么个操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1. 获取本地信息Src</span><br><span class="line">2. http get获得xml，把本地信息Src与title进行循环xor得到SrcXor</span><br><span class="line">3. 组成packet： 0x1FACEEEE | Size | SrcXor ， 进行base64编码，得到Base64Packet</span><br><span class="line">4. 获取到到pubdata作为http包additional header，把Base64Packet作为数据post到mugatu.flare-on.com</span><br><span class="line">5. 返回数据进行base64解码，并检查header xor 0x4D是否为&quot;orange mocha frappuccino&quot;，若是，则写到文件`\\.\mailslot\Let_me_show_you_Derelicte`</span><br><span class="line">6. 从binary load image g和f，用gdi32_BitBlt两张图片xor，并用gdi32_GetObjectW提取信息， </span><br><span class="line">7. data段数据，VirtualProtect 修改成 rwx，没细看，image_f 包含一个dll数据</span><br><span class="line">8. createThread，调用dll的导出函数，</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>然后就可以去分析dll了</p>
<p>这个dll也做了跟exe一样的import table混淆</p>
<p>结合调试，得到参数结构体的数据</p>
<p>就是从硬盘中搜索gif并加密</p>
<p>加密函数看了看，非常眼熟，😯是个xtea</p>
<p>但是密钥是刚开始的时候访问网络得到的，那个是个现在已经访问不了的url</p>
<p>但题目还有个提示，文件<code>the_key_to_success_0000.gif.Mugatu</code></p>
<p>直接解出来</p>
<p><img src="/2019/10/08/Flare-On-2019-Writeup/10-out.gif" alt="10-out"></p>
<p>密钥是4个byte的，这么就3个byte直接爆破了</p>
<p>得到flag</p>
<p><img src="/2019/10/08/Flare-On-2019-Writeup/10-flag.gif" alt="10-flag"></p>
<hr>
<p><strong>PS:</strong> 这gif图怎么这么骚气！（Dear God…It’s beautiful）</p>
<p>这题有意思的地方应该是在import table混淆上</p>
<p>emmmm 看了一下官方wp，原来这个混淆是这么简单，在WinMain调用之前，start的最开始调用了一个函数，把import address table（IAT）翻转了。。。因为反编译器通常都不会处理这种情况</p>
<p>至于怎么去混淆，也不用像我这么蠢手动恢复，直接在跑起来后dump memory再分析就好了</p>
<h2 id="11-vv-max"><a href="#11-vv-max" class="headerlink" title="11 - vv_max"></a>11 - vv_max</h2><p>这题就有意思了，上来先给你来个AVX2指令集</p>
<p>先检查一下CPU支不支持AVX2，然后就开始了程序的逻辑</p>
<p>大概看出来像是个VM，对那个贼大的结构体恢复了一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">YMM</span>&#123;</span></span><br><span class="line">    <span class="keyword">char</span> value[<span class="number">32</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VM</span>&#123;</span></span><br><span class="line">    <span class="keyword">char</span> text[<span class="number">2048</span>];</span><br><span class="line"><span class="comment">//reg1: 2048 0x800</span></span><br><span class="line"><span class="comment">//reg2: 2304 0x900</span></span><br><span class="line"><span class="comment">//reg3: 2560 0xa00</span></span><br><span class="line"><span class="comment">//reg4: 2861 0xb00</span></span><br><span class="line">    YMM reg[<span class="number">32</span>];</span><br><span class="line"><span class="comment">//rip: 3072 0xc00</span></span><br><span class="line">    QWORD rip;</span><br><span class="line">    <span class="keyword">void</span> *funclist[<span class="number">24</span>];</span><br><span class="line"><span class="comment">//data: 3272 0xcc8</span></span><br><span class="line">    <span class="keyword">char</span> data[<span class="number">1848</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后看了半天的文档，写了个反汇编器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*-coding:utf-8-*-</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">disasm</span><span class="params">(text)</span>:</span></span><br><span class="line">    f = open(<span class="string">'dis.txt'</span>, <span class="string">'w'</span>)</span><br><span class="line">    ip = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> ip &lt; len(text):</span><br><span class="line">        f.write(<span class="string">'&#123;&#125;: '</span>.format(ip))    </span><br><span class="line">        <span class="keyword">if</span> ip &gt; <span class="number">2</span> <span class="keyword">and</span> ip &lt; <span class="number">32</span>+<span class="number">3</span>:</span><br><span class="line">            ip += <span class="number">1</span></span><br><span class="line">            f.write(<span class="string">'reserve INPUT1\n'</span>)</span><br><span class="line">        <span class="keyword">elif</span> ip &gt;= <span class="number">37</span> <span class="keyword">and</span> ip &lt; <span class="number">37</span> + <span class="number">32</span>:</span><br><span class="line">            ip += <span class="number">1</span></span><br><span class="line">            f.write(<span class="string">'reserve INPUT2\n'</span>)</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">0</span>:</span><br><span class="line">            ip += <span class="number">1</span></span><br><span class="line">            f.write(<span class="string">'EmptyReg\n'</span>)</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">1</span>:</span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'muladd16 r&#123;&#125;, r&#123;&#125;, r&#123;&#125;\n'</span>.format(param1, param2, param3))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">2</span>:</span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'muladd32 r&#123;&#125;, r&#123;&#125;, r&#123;&#125;\n'</span>.format(param1, param2, param3))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">3</span>:</span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'xor r&#123;&#125;, r&#123;&#125;, r&#123;&#125;\n'</span>.format(param1, param2, param3))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">4</span>:</span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'or r&#123;&#125;, r&#123;&#125;, r&#123;&#125;\n'</span>.format(param1, param2, param3))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">5</span>:</span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'and r&#123;&#125;, r&#123;&#125;, r&#123;&#125;\n'</span>.format(param1, param2, param3))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">6</span>:</span><br><span class="line">            param1, param2 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>]</span><br><span class="line">            ip += <span class="number">3</span></span><br><span class="line">            f.write(<span class="string">'not r&#123;&#125;, r&#123;&#125;\n'</span>.format(param1, param2))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">7</span>:</span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'add8 r&#123;&#125;, r&#123;&#125;, r&#123;&#125;\n'</span>.format(param1, param2, param3))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">8</span>:</span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'sub8 r&#123;&#125;, r&#123;&#125;, r&#123;&#125;  # p1 = p2 - p3\n'</span>.format(param1, param2, param3))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">9</span>: <span class="comment"># not check below</span></span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'add16 r&#123;&#125;, r&#123;&#125;, r&#123;&#125;\n'</span>.format(param1, param2, param3))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">10</span>:</span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'sub16 r&#123;&#125;, r&#123;&#125;, r&#123;&#125;\n'</span>.format(param1, param2, param3))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">11</span>:</span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'add32 r&#123;&#125;, r&#123;&#125;, r&#123;&#125;\n'</span>.format(param1, param2, param3))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">12</span>:</span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'sub32 r&#123;&#125;, r&#123;&#125;, r&#123;&#125;\n'</span>.format(param1, param2, param3))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">13</span>:</span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'add64 r&#123;&#125;, r&#123;&#125;, r&#123;&#125;\n'</span>.format(param1, param2, param3))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">14</span>:</span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'sub64 r&#123;&#125;, r&#123;&#125;, r&#123;&#125;\n'</span>.format(param1, param2, param3))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">15</span>:</span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'muldq r&#123;&#125;, r&#123;&#125;, r&#123;&#125;\n'</span>.format(param1, param2, param3))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">16</span>:</span><br><span class="line">            param1, param2 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>]</span><br><span class="line">            ip += <span class="number">3</span></span><br><span class="line">            f.write(<span class="string">'movdq r&#123;&#125;, r&#123;&#125;\n'</span>.format(param1, param2))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">17</span>:</span><br><span class="line">            param1 = text[ip+<span class="number">1</span>]</span><br><span class="line">            ip += <span class="number">2</span></span><br><span class="line">            f.write(<span class="string">'movdq r&#123;&#125;, mem[&#123;&#125;]\n'</span>.format(param1, ip))</span><br><span class="line">            array = [text[ip + j] <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>)]</span><br><span class="line">            f.write(<span class="string">'\t(&#123;&#125;-&#123;&#125;): '</span>.format(ip, ip+<span class="number">32</span>) + str(array) + <span class="string">'\n'</span>)</span><br><span class="line">            ip += <span class="number">32</span></span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">18</span>:</span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'srld r&#123;&#125;, r&#123;&#125;, &#123;&#125;\n'</span>.format(param1, param2, param3))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">19</span>:</span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'slld r&#123;&#125;, r&#123;&#125;, &#123;&#125;\n'</span>.format(param1, param2, param3))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">20</span>:</span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'shufb r&#123;&#125;, r&#123;&#125;, r&#123;&#125;\n'</span>.format(param1, param2, param3))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">21</span>:</span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'permd r&#123;&#125;, r&#123;&#125;, r&#123;&#125;\n'</span>.format(param1, param3, param2))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">22</span>:</span><br><span class="line">            param1, param2, param3 = text[ip+<span class="number">1</span>], text[ip+<span class="number">2</span>], text[ip+<span class="number">3</span>]</span><br><span class="line">            ip += <span class="number">4</span></span><br><span class="line">            f.write(<span class="string">'cmpeq r&#123;&#125;, r&#123;&#125;, r&#123;&#125;\n'</span>.format(param1, param2, param3))</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">23</span>:</span><br><span class="line">            ip += <span class="number">1</span></span><br><span class="line">            f.write(<span class="string">'nop\n'</span>)</span><br><span class="line">        <span class="keyword">elif</span> text[ip] == <span class="number">0xff</span>:</span><br><span class="line">            ip += <span class="number">1</span></span><br><span class="line">            f.write(<span class="string">'exit\n'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            f.write(<span class="string">'unknown: &#123;&#125;'</span>.format(text[ip]))</span><br><span class="line">            ip += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    text = open(<span class="string">'text.bin'</span>, <span class="string">'r'</span>).read()</span><br><span class="line">    text = map(ord, text)</span><br><span class="line">    disasm(text)</span><br></pre></td></tr></table></figure>
<p>然后就是要去逆这个东西了</p>
<p>总结了一下最后检查部分的要求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">final check:</span><br><span class="line">1. reg2 == reg20</span><br><span class="line">2. input1[:9] == &apos;FLARE2019&apos;</span><br><span class="line">flag = reg1 xor reg31</span><br></pre></td></tr></table></figure>
<p>其中，R20是个固定的数组，可以直接从调试中获得</p>
<p>R2跟我们的输入有关，接下来就是看R2到底进行了哪些操作了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">781: srld r7, r1, 4</span><br><span class="line">813: and r7, r7, r6</span><br><span class="line">849: cmpeq r8, r1, r6       // 0000000 ？</span><br><span class="line">889: add8 r7, r8, r7        // equal - 1 / not equal = 0</span><br><span class="line">901: shufb r7, r5, r7</span><br><span class="line"></span><br><span class="line">949: add8 r2, r1, r7</span><br><span class="line">1029: muladd16 r7, r2, r10</span><br><span class="line">1109: muladd32 r2, r7, r11</span><br><span class="line">1297: shufb r2, r2, r12</span><br><span class="line">1421: permd r2, r13, r2</span><br><span class="line">1029: muladd16 r7, r2, r10</span><br><span class="line">1109: muladd32 r2, r7, r11</span><br></pre></td></tr></table></figure>
<p>主要翻了半天文档，去理解这些指令</p>
<p>刚开始我打算直接写Z3跑的，但在理解了这些指令的运算后，感觉好像没那么好写？</p>
<p>而且关键是，这指令的个数不多，应该可以直接写逆</p>
<p>但是这时有个关键点，muladd这种指令不好写逆</p>
<p>这时，我注意到一个东西，因为当中包含有常数数组，所以结合起来有如下的特点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">muladd32:</span><br><span class="line">r2[31:0] = 0x1000 * r7[15:0] + r7[31:16]</span><br><span class="line">         = r2[7:0] &lt;&lt; 18  + r2[15:8] &lt;&lt; 12 + r2[23:16] &lt;&lt; 6 + r2[31:24]</span><br></pre></td></tr></table></figure>
<p>6，12，18，24</p>
<p>每一段只占6个bit</p>
<p>这让我想起了base64</p>
<p>但是结合上下文我根本看不出来这是一个base64算法，因为还有一些奇怪的操作</p>
<p>但这时我从网上搜到这篇，用AVX2实现base64算法<a href="https://arxiv.org/pdf/1704.00605.pdf" target="_blank" rel="noopener">https://arxiv.org/pdf/1704.00605.pdf</a></p>
<p>哦对！我还可以调试，直接当成黑盒看一下输入输出的关系</p>
<p>然后就发现。。。</p>
<p>这是一个base64 decode</p>
<p>然后就出来了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.\vv_max.exe FLARE2019 cHCyrAHSXmEKpyqoCByGGuhFyCmy86Ee</span><br><span class="line">That is correct!</span><br><span class="line">Flag: AVX2_VM_M4K3S_BASE64_C0MPL1C4T3D@flare-on.com</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>PS:</strong> 骚操作真多</p>
<p>这题官方解法没有很特别的地方</p>
<p>以后遇到这些算法就学会了，先当成黑盒去猜，然后再去逆</p>
<h2 id="12-help"><a href="#12-help" class="headerlink" title="12 - help"></a>12 - help</h2><p>这是我做过最最最最难的一道题了！前面11道题，基本花费时间都不会超过两天，这题，断断续续抽空做弄了足足20天！我真是太太太太太菜了，但真的学到了非常多</p>
<p>首先说说这题吧，给了一个window的crash dump文件，大小2G，然后还有一个pacp</p>
<p>翻了一遍，发现一堆一堆的192.168.1.244和192.168.1.243的TCP交互数据，但是看不出来是啥数据</p>
<p>有一堆以8 bytes重复的字符</p>
<p>还看到了一些正常http访问的数据包</p>
<p>那么就去分析crash dump文件吧</p>
<p>因为之前没有弄过，所以先去网上搜了一波，用windbg拿到了一些信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Windows 7 Kernel Version 7601 (Service Pack 1) UP Free x64</span><br><span class="line">Product: WinNt, suite: TerminalServer SingleUserTS Personal</span><br><span class="line">Built by: 7601.18741.amd64fre.win7sp1_gdr.150202-1526</span><br><span class="line">...</span><br><span class="line">BugCheck 7E, &#123;ffffffffc0000005, fffffa8003f9c621, fffff88007c6b958, fffff88007c6b1b0&#125;</span><br><span class="line"></span><br><span class="line">*** WARNING: Unable to verify timestamp for man.sys</span><br><span class="line">*** ERROR: Module load completed but symbols could not be loaded for man.sys</span><br><span class="line">Probably caused by : man.sys ( man+1ce7 )</span><br></pre></td></tr></table></figure>
<p>看起来，问题出在了man.sys这个文件上，因为题目描述说道是病毒文件存在bug把电脑搞崩了</p>
<p>那么怎么分析这个文件呢</p>
<p>有一个很出名的工具叫volatility</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility.exe -f &apos;.\12 - help\help.dmp&apos; --profile=Win7SP1x64 modscan &gt; .\ana\modscan</span><br></pre></td></tr></table></figure>
<p>Then I found <code>man.sys</code> by modscan.</p>
<p>But when I try to dump this file,</p>
<p><code>volatility.exe -f &#39;.\12 - help\help.dmp&#39; --profile=Win7SP1x64 moddump -D dump2 --regex=man.sys</code></p>
<p>I got<br><code>0xfffff880033bc000 man.sys              Error: e_magic 0000 is not a valid DOS signature.</code></p>
<p>emmmmm 这个文件的文件头似乎被抹掉了</p>
<p>然后就发现可以用volshell dump出来</p>
<p><a href="https://lists.volatilityfoundation.org/pipermail/vol-users/2013-March/000829.html" target="_blank" rel="noopener">https://lists.volatilityfoundation.org/pipermail/vol-users/2013-March/000829.html</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = addrspace().zread(assumed_base_address, assumed_module_size)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">with</span> open(<span class="string">'file.dmp'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">......        f.write(data)</span><br></pre></td></tr></table></figure>
<p>dump出来后，因为没有文件头，分析不了</p>
<p>后来我发现ghidra可以直接识别到函数，所以就用ghidra做了（后来别人告诉我其实ida也可以的，不过只是要在初始化时选一个参数）</p>
<p>这样我就不用一个个找0x55然后C了</p>
<hr>
<p>因为刚开始只有一个去掉文件头的man.sys </p>
<p>我当时在想里面会不会藏有什么东西，就试着binwalk了一下，果然发现了一个dll文件</p>
<p>根据pdb字符串，这个就叫<code>m.dll</code></p>
<p><code>e:\dropbox\dropbox\flareon_2019\code\cd\objchk_win7_amd64\amd64\m.pdb</code></p>
<p>分析m.dll，去掉RC4的混淆，逆完发现他是在本地监听4444端口，然后根据发送过来的数据包调用相应的ioctl</p>
<p>看来还是得继续逆man.sys</p>
<p>man.sys好多奇怪的操作</p>
<p>emmmmm 还有好多疑似import的函数</p>
<p><img src="/2019/10/08/Flare-On-2019-Writeup/12-libFunc.png" alt="12-libFunc"></p>
<p>emmmm 这个地址，是什么函数呢？</p>
<p>啊！我能直接通过windbg查看！</p>
<p>这么就能一个个恢复出来了</p>
<p><img src="/2019/10/08/Flare-On-2019-Writeup/12-getlibFuncInWindbg.png" alt="12-getlibFuncInWindbg"></p>
<p>花了比较长的时间去逆man.sys，主要注意到他的ioctl的操作，都是从一个链表中搜索代码出来调用，调用的似乎都是export函数</p>
<p>在man.sys初始化的时候，会通过同样的函数调用m.dll的export函数，从而在本地开启4444端口监听</p>
<p>那么就计划先来分析一下4444端口接收到的数据进行了什么ioctl的调用吧</p>
<p>诶？？这数据完全对不上？？</p>
<p>我是哪里弄错了吗？</p>
<p>卡了一轮，无果，我以为我是开头哪里搞错了</p>
<p>上twitter问了一下大佬@hasherezade</p>
<blockquote>
<p>How many DLLs did you extract? There is one dll which functionality is to encrypt the traffic…</p>
</blockquote>
<p>emmmmmm</p>
<p>我太菜了</p>
<p>好的，然后我就知道往哪个方向去继续做了</p>
<p>我用volatility把基本能跑的都跑了一遍，似乎好像没发现什么特别的东西</p>
<p>在driver、module相关的信息里面倒是看到挺多flare on字样的驱动等等，但是似乎都提不出来，定位不到文件</p>
<p>这时看回man.sys，我主要到一个东西，加载的m.dll是要先attach到pid=876的进程上！</p>
<p>然后去查看pid 876，是svchost.exe，针对这个进程，emmmmm各种方法都找不到那些隐藏的dll</p>
<p>然后试着用yarascan命令搜了一下driver的ID <code>FLID</code></p>
<p>突然发现，在附近带有pdb的字符串！，我可以直接搜索pdb！</p>
<p><code>volatility.exe -f &#39;.\12 - help\help.dmp&#39; --profile=Win7SP1x64 yarascan -Y dropbox\\dropbox\\flareon_2019\\code --pid=876 &gt; .\ana\yarascan_code</code></p>
<p>Jesus…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">24d0a4 E:\Dropbox\Dropbox\flareon_2019\code\stmedit\sys\x64\Release\stmedit.pdb</span><br><span class="line">2934fc e:\dropbox\dropbox\flareon_2019\code\cryptodll\objchk_win7_amd64\amd64\c.pdb</span><br><span class="line">29650c e:\dropbox\dropbox\flareon_2019\code\networkdll\objchk_win7_amd64\amd64\n.pdb</span><br><span class="line">2a0508 e:\dropbox\dropbox\flareon_2019\code\keylogdll\objchk_win7_amd64\amd64\k.pdb</span><br><span class="line">2a74fc e:\dropbox\dropbox\flareon_2019\code\screenshotdll\objchk_win7_amd64\amd64\s.pdb</span><br><span class="line">2ac4fc e:\dropbox\dropbox\flareon_2019\code\filedll\objchk_win7_amd64\amd64\f.pdb</span><br><span class="line">6cbe124 e:\dropbox\dropbox\flareon_2019\code\id\objchk_win7_amd64\amd64\man.pdb</span><br><span class="line">6cbf600 e:\dropbox\dropbox\flareon_2019\code\cd\objchk_win7_amd64\amd64\m.pdb</span><br><span class="line">1af27b80 e:\dropbox\dropbox\flareon_2019\code\shellcodedriver\objchk_wxp_x86\i386\driver1.pdb</span><br></pre></td></tr></table></figure>
<p>然后我就结合binwalk把这些都dump出来了</p>
<p>注意到他们目录名称非常有意思</p>
<p><code>stmedit</code> <code>cryptodll</code> <code>networkdll</code> <code>keylogdll</code> <code>screenshotdll</code> <code>filedll</code> <code>shellcodedriver</code></p>
<p>刚开始我完全没看懂stmedit是什么东西，逆了一下完全没看懂，非常复杂</p>
<p>然后我去搜了一下……搜到了一个同名的MS的driver example</p>
<p><a href="https://github.com/microsoft/Windows-driver-samples/tree/master/network/trans/stmedit" target="_blank" rel="noopener">https://github.com/microsoft/Windows-driver-samples/tree/master/network/trans/stmedit</a></p>
<p>原来这就是那个加密TCP流的driver！</p>
<p>他通过WPF的api替换TCP上的数据</p>
<p>结合这MS的sample逆了大半天，终于找到那个关键的函数了，是一个8bytes密钥的xor</p>
<p>并且，能从这个sys里面找到初始化4444端口的密钥，但是别的端口都是通过ioctl配置的，根本找不到密钥</p>
<p>先解4444端口的好了</p>
<p>刚开始我想沿用第4题的方法，同scapy提出来，但是存在一个问题，数据太多TCP包被拆分了，需要TCP重组，然后又是查了半天的资料，后来发现直接用wireshark就可以提出来了= =</p>
<p>然后就把4444端口的数据解出来了</p>
<hr>
<p>首先，数据大量调用了0xd180dab5的ioCode</p>
<p>解析出来的数据类似下面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&apos;buf&apos;: &apos;GG\xda\xbe\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&apos;, &apos;ioCode&apos;: &apos;0xd180dab5&apos;, &apos;size&apos;: 26&#125;</span><br></pre></td></tr></table></figure>
<p>结合man.sys可以猜测这是远程发送控制调用相应的函数，其中buf的前4个byte是指明调用的哪个dll，但是我找不到这些值是在哪里初始化的，也就是说我并不知道他这调用了哪个函数</p>
<p>先总结一下前面提取出来的dll的作用，很快就逆了一遍，这都不难</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">stmedit.sys: 	TCP包加密</span><br><span class="line">c.dll:				数据加密，先用lznt1压缩，再用rc4加密，密钥是username &apos;FLARE ON 2019\x00&apos;</span><br><span class="line">n.dll:				数据打包，发送到ip 192.268.1.243</span><br><span class="line">k.dll:				键盘记录，保存并打包</span><br><span class="line">s.dll:				屏幕截图，bmp格式</span><br><span class="line">f.dll:				文件操作，读文件，文件搜索，文件写等</span><br><span class="line">man.sys:			控制driver</span><br><span class="line">m.dll:				4444监听端口</span><br><span class="line">driver1.sys:	执行shellcode</span><br></pre></td></tr></table></figure>
<p>于是总结了一下数据包</p>
<p>4444接受发送来的数据</p>
<p>6666 7777 8888 都是发送到ip 192.268.1.243的数据</p>
<p>其中7777dump出来的数据包非常有规律，正是8byte的循环，虽然上面dll还有个数据加密的dll，但7777没有用到</p>
<p>后面再细逆man.sys就会发现，在dll的函数调用完毕后，会有一个设置的标志位，只有设置了那个标志位的数据，才会调用c.dll进行数据加密</p>
<p>6666 8888传输的数据均经过加密，而7777则没有</p>
<p>因为4444数据中包含了接收文件的操作，和有显示出来的字符串<code>C:\\keypass\\keys.kdb</code>，可以确定几个man.sys调用的函数</p>
<p>4444接收的文件我dump出来看了一下，其实正是driver1.sys，这个我们已经分析过了</p>
<p>而那个字符串，结合调用的f.dll逆，可以发现他的操作是</p>
<ol>
<li>在C盘搜索keys.kdb文件</li>
<li>发送keys.kdb文件出去</li>
</ol>
<p>那么6666 7777 8888 端口的数据我们就能猜测一下，分别是发送的key.kdb数据，屏幕截图数据和键盘记录数据</p>
<p>其中7777的数据量最大，数据包最多，可以先猜测这是屏幕截图数据</p>
<p>因为只是xor加密，而7777每次发送的数据都是<code>packet_len + bmpdata</code>的结构</p>
<p>bmp头有十几个byte的数据是已知的，那么就可以破解出密钥！</p>
<p><code>key = &#39;J\x1fK\x1c\xb0\xd8%\xc7&#39;</code></p>
<p>当我把屏幕截图解完，就发现了非常有意思的图片</p>
<p><img src="/2019/10/08/Flare-On-2019-Writeup/12-pkt150.bmp" alt="12-pkt150"></p>
<p><img src="/2019/10/08/Flare-On-2019-Writeup/12-pkt164.bmp" alt="12-pkt164"></p>
<p>结合图片可以知道flag就藏在keys.kdb里面！（不是看到这个我都差点忘了我是要找flag的了。。。）</p>
<p>打开keys.kdb的master key长度是18</p>
<p>接下来自然可以想到目标是解密出6666和8888端口的数据</p>
<p>拿到keys.kdb文件，并且从keylogger数据中读到密码</p>
<hr>
<p>解密6666 8888的数据</p>
<p>7777的密钥是我们直接破解出来的，但是6666和8888的数据因为还再加了一层加密，就很难这么干了</p>
<p>因为加密顺序是LZNT1 compress -&gt; RC4 with key ‘FLARE ON 2019\x00’ -&gt; xor with xor key</p>
<p>可以先猜出前面的一点点数据，然后同理加密后破解</p>
<p>但尝试了一段时间没有成功，也不知道哪里出问题了，理论上是可以的</p>
<p>于是我又卡住了</p>
<p>之后我在dump数据包出来的时候，发现了一样东西<img src="/2019/10/08/Flare-On-2019-Writeup/12-pkgtrick.png" alt="12-pkgtrick"></p>
<p>这里是同一个TCP数据包，怎么有两块长度一样的？</p>
<p>然后翻到下面的数据包，发现开头是<code>\x10\x09\x00\x00</code>，这不正是发出去的数据包的格式，前4个byte是包长度吗</p>
<p>但是正常情况应该是这4个字节也经过了xor加密</p>
<p>然后我就发现，这个包里面前半部分是经过xor加密的数据，后半部分是未经过xor加密的数据，两个数据是一样的。。。（或许是正如截图里的encrypt加密了两次？）</p>
<p>总的来说，这是stmedit没有逆清楚的锅，有可能是因为API用的Inject，原数据没有删掉（这里原因还不清楚</p>
<p>总之，接着这个思路6666和8888的数据都拿到了</p>
<p>keys.kdb拿到了</p>
<p>keylog也拿到了</p>
<p>从keylog拿到的密钥是<code>th1sisth33nd111</code>，这只有15位，还缺了3位</p>
<p>再细逆keylogger，发现这个keylogger问题很大</p>
<ol>
<li>特殊字符不能记录到</li>
<li>大小写统一都转换成小写</li>
</ol>
<p>从twitter上看到别人说从截图推断出来密码，嗯？？？</p>
<p>然后我就有点点被误导了</p>
<p>根据语义试了一堆</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Th1s_Is_TH3_3nd111</span><br><span class="line">Th1s_Is_Th3_3nd111</span><br><span class="line">Th1s-is_th3-3nd111</span><br><span class="line">Th1s-is-th3_3nd111</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>卡了整整一天后，我就去问大佬了</p>
<p>超感谢@zvikam非常多的提示，指导我怎么去找到这个key</p>
<p>试着从dump文件中搜了一下<code>3nd</code></p>
<p>居然找到了！</p>
<p><code>Th!s_iS_th3_3Nd!!!</code></p>
<p>终于拿到了flag</p>
<hr>
<p>其中前面我刚开始爆破的时候思路有点错了，我着重爆破的是那3个不可见字符，大小写没有太多的考虑</p>
<p>并且！我没想到叹号会被转化成1，现在再细看，的确就是这样的，这个keylogger对于特殊字符没有检查shift，所以0-9键盘上的特殊字符都会被转化成数字</p>
<p>所以其实爆破也是一个正解，只不过我爆破的方向不对</p>
<p>这整一个病毒的思路非常明确</p>
<p>Man.sys是主病毒，通过4444端口接收控制数据</p>
<p>再发送捕获的数据到 6666 7777 8888 端口</p>
<hr>
<p><strong>PS：</strong>官方题解是直接用的windbg做的，tql</p>
<p>这里说好一下一些我自己做的时候没注意到的关键点</p>
<p>crash dump的原因是因为man.sys下载了一段32位的驱动，但系统是64位的，当32位驱动试图运行在64位系统的时候，系统crash了</p>
<p> 至于man.sys头部被抹掉，官方的一种做法是把另外的sys文件头复制过来，再手动修正，只要确保.text是对的就OK了，其他部分可以一律看作.data</p>
<p>我是手动恢复RC4混淆的字符串的。。的确是太蠢太麻烦了，可以通过ida的插件辅助完成</p>
<p><a href="https://github.com/fireeye/flare-emu" target="_blank" rel="noopener">https://github.com/fireeye/flare-emu</a></p>
<p>emmmm关于我提取dll的方式，那的确是另一种方式</p>
<p>这些dll不是全都注入到svchost里的，因为有些dll的安装方式是通过ioctl，最终这些信息都储存在man.sys的那个链表中</p>
<p>关键点在这，因为这些都是直接从crash dump中获得的，那个链表我们其实可以直接通过windbg跟踪查看具体数据，通过这个信息，我们可以看到具体是注入到哪个进程，以及dll捆绑的端口是多少</p>
<p>引用一下官方wp的结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">INJECTED_PAYLOADS</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG moduleId;</span><br><span class="line">    LIST_ENTRY link;</span><br><span class="line">    KMUTEX payloadMutex;</span><br><span class="line">    ULONG_PTR baseAddress;</span><br><span class="line">    ULONG_PTR runOffset;</span><br><span class="line">    ULONG_PTR loadedDllSize;</span><br><span class="line">    BOOLEAN isExfilDll; <span class="comment">// Sends data to 192.168.1.243</span></span><br><span class="line">    BOOLEAN isCryptoDll; <span class="comment">// Used to encrypt some payloads’ return data</span></span><br><span class="line">    ULONG exfilPort; <span class="comment">// Set per payload at injection time</span></span><br><span class="line">    PEPROCESS injectedProcess;</span><br><span class="line">&#125; INJECTED_PAYLOADS, *PINJECTED_PAYLOADS;</span><br></pre></td></tr></table></figure>
<p>像这些都是可以获得的</p>
<p>同理，stmedit在安装端口加密也是通过ioctl实现的，并且同样包含一个链表，dump出这个链表同样是可以找到加密的key，并不是一定要靠猜的</p>
<hr>
<p>关于其他大佬的做法，也能学到很多</p>
<p><a href="https://bruce30262.github.io/flare-on-challenge-2019-write-up/#level-12" target="_blank" rel="noopener">https://bruce30262.github.io/flare-on-challenge-2019-write-up/#level-12</a></p>
<p>中提到，在逆man.sys的时候，要恢复库函数，可以通过Volatility的帮助</p>
<blockquote>
<p><em>Later did I know that you can just use Volatility’s</em> <a href="https://github.com/volatilityfoundation/volatility/wiki/Command-Reference-Mal#impscan" target="_blank" rel="noopener">impscan</a> <em>command to identify calls to APIs. The command even has an option to generate an IDA .idc file that help us mark the function name in IDA !</em></p>
</blockquote>
<p>还有一个写得超详细的大佬在获取键盘记录上提供了一个非常刺激的思路</p>
<p><a href="https://github.com/eleemosynator/writeups/tree/master/flare-on-6/12 - help" target="_blank" rel="noopener">https://github.com/eleemosynator/writeups/tree/master/flare-on-6/12%20-%20help</a></p>
<p>大致意思就是根据windows键盘驱动云云～～可以直接从windows驱动拿到键盘Keystroke event信息</p>
<blockquote>
<ul>
<li>Keyboard issues a processor interrupt when a keystroke event (key-up or key-down) is ready to be processed.</li>
<li>The [Interrupt Service Routine] of the low-level keyboard driver <code>i8042prt.sys</code> handles the interrupt.</li>
<li>As the operating system may be busy with other things when the keyboard interrupt is received, <code>i8042prt.sys</code> stores the keystroke event in a ring buffer (which resides in Non-Paged memory) which the OS can then process at its leisure.</li>
</ul>
</blockquote>
<p>这个方法简直太炫酷了，这样就可以直接拿到键盘记录数据，而不是靠猜靠爆破了</p>
<p><strong>高能预警！！！</strong></p>
<p>然后还有大佬是………………纯粹靠数据分析？？？？</p>
<p><a href="https://sysenter-eip.github.io/FlareOn2019_NoReversing" target="_blank" rel="noopener">https://sysenter-eip.github.io/FlareOn2019_NoReversing</a></p>
<p>screenshot数据是直接看出来8byte xor然后用GBS（一个工具）处理查看发现是图片，然后猜key解出来的</p>
<p>在看完截图知道需要获得kdb后，直接从crash dump中得到了keys.kdb文件</p>
<p>然后猜了一下可能存在keylogger数据，和8888端口发送的数据包用的是同一个密钥，对比不同的数据包，发现有相同的MSB存在，就用滑动窗口去破解了（Orz）并且猜出来许多windows的病毒都是使用LZNT1</p>
<p>剩下就跟我一样在crash dump中搜到了master key</p>
<p>还有一种情况，既然拿到keys.kdb了，那是不是可以直接破解这个文件？</p>
<p>答案是可以的，需要逆一下cng.sys</p>
<p><a href="https://gist.github.com/Sin42/feb693a5b29679f8137b2d751aeb1e31" target="_blank" rel="noopener">https://gist.github.com/Sin42/feb693a5b29679f8137b2d751aeb1e31</a></p>
<p>直接就把keys.kdb破解了 Orz</p>
<p>佩服得五体投地</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>其实整篇文章都写得像流水账，主要记录的是我的解题过程，我当时是怎么想的</p>
<p>详细的writeup网上有很多，而且flareon官方的writeup也足够详细</p>
<p>这总是能让我学到许多</p>
<p>大佬们都tqltql Orz</p>
<p>希望明年能再接再厉</p>
<p>要说真的挑一道自己喜欢的题目，那可能就是12题吧，因为真的学到了许多许多，非常偏向于实际的病毒分析</p>
<p>但是也折磨得我够呛的Orz</p>
<p>感谢flareon的组织（我们明年再见（滑稽））</p>
<p>PPS：牌子什么时候才能寄到呢？</p>

      
      
        <div class="page-reward">
          <p><a href="javascript:void(0)" onclick="dashangToggle()" class="dashang">赏</a></p>
          <div class="hide_box"></div>
          <div class="shang_box">
            <a class="shang_close" href="javascript:void(0)" onclick="dashangToggle()">×</a>
            <div class="shang_tit">
              <p>赞助gif换电脑、吃双皮奶(逃</p>
            </div>
            <div class="shang_payimg">
              <img src="/img/alipayimg.jpg" alt="扫码支持" title="扫一扫" />
            </div>
              <div class="pay_explain">扫码打赏，你说多少就多少</div>
            <div class="shang_payselect">
              
                <div class="pay_item checked" data-id="alipay">
                  <span class="radiobox"></span>
                  <span class="pay_logo"><img src="/img/alipay.png" alt="支付宝" /></span>
                </div>
              
              
                <div class="pay_item" data-id="wechat">
                  <span class="radiobox"></span>
                  <span class="pay_logo"><img src="/img/weixin.png" alt="微信" /></span>
                </div>
              
            </div>
            <div class="shang_info">
              <p>打开<span id="shang_pay_txt">支付宝</span>扫一扫，即可进行扫码打赏哦</p>
            </div>
          </div>
        </div>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
        <script type="text/javascript">
          $(".pay_item").click(function(){
            $(this).addClass('checked').siblings('.pay_item').removeClass('checked');
            var dataid=$(this).attr('data-id');
            $(".shang_payimg img").attr("src","/img/"+dataid+"img.jpg");
            $("#shang_pay_txt").text(dataid=="alipay"?"支付宝":"微信");
          });
          function dashangToggle(){
            
            $(".hide_box").fadeToggle();
            $(".shang_box").fadeToggle();
          }
        </script>
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2019/10/08/Flare-On-2019-Writeup/">Flare-On 2019 Writeup</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 giglf 的个人博客">giglf</a></p>
        <p><span>发布时间:</span>2019年10月08日 - 17时44分</p>
        <p><span>最后更新:</span>2019年10月11日 - 16时46分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2019/10/08/Flare-On-2019-Writeup/" title="Flare-On 2019 Writeup">http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/</a>
            <span class="copy-path" data-clipboard-text="原文: http://giglf.github.io/2019/10/08/Flare-On-2019-Writeup/　　作者: giglf" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
  
    <a href="/2018/11/21/2018flare-on-recording/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">2018flare-on recording</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#写在前面"><span class="toc-number">1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Memecat-Battlestation"><span class="toc-number">2.</span> <span class="toc-text">1 - Memecat Battlestation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Overlong"><span class="toc-number">3.</span> <span class="toc-text">2 - Overlong</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Flarebear"><span class="toc-number">4.</span> <span class="toc-text">3 - Flarebear</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Dnschess"><span class="toc-number">5.</span> <span class="toc-text">4 - Dnschess</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-demo"><span class="toc-number">6.</span> <span class="toc-text">5 - demo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-bmphide"><span class="toc-number">7.</span> <span class="toc-text">6 - bmphide</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-wopr"><span class="toc-number">8.</span> <span class="toc-text">7 - wopr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-snake"><span class="toc-number">9.</span> <span class="toc-text">8 - snake</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-reloadered"><span class="toc-number">10.</span> <span class="toc-text">9 - reloadered</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-Mugatu"><span class="toc-number">11.</span> <span class="toc-text">10 - Mugatu</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-vv-max"><span class="toc-number">12.</span> <span class="toc-text">11 - vv_max</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-help"><span class="toc-number">13.</span> <span class="toc-text">12 - help</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">14.</span> <span class="toc-text">总结</span></a></li></ol>
</div>
<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }
    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
        }
    })
    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
    }
</script>





<div class="bdsharebuttonbox">
	<a href="#" class="fx fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="fx fa-weixin bds_weixin" data-cmd="weixin" title="分享到微信"></a>
	<a href="#" class="fx fa-qq bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
	<a href="#" class="fx fa-facebook-official bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
	<a href="#" class="fx fa-twitter bds_twi" data-cmd="twi" title="分享到Twitter"></a>
	<a href="#" class="fx fa-linkedin bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
	<a href="#" class="fx fa-files-o bds_copy" data-cmd="copy" title="分享到复制网址"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>




    
        <!-- 来必力City版安装代码 -->
        <div id="lv-container" data-id="city" data-uid="MTAyMC8zMTEzNi83Njg1">
            <script type="text/javascript">
           (function(d, s) {
               var j, e = d.getElementsByTagName(s)[0];
               if (typeof LivereTower === 'function') { return; }
               j = d.createElement(s);
               j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
               j.async = true;
               e.parentNode.insertBefore(j, e);
           })(document, 'script');
            </script>
        <noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
        </div>
        <!-- City版安装代码已完成 -->
    



    <div class="scroll" id="post-nav-button">
        
            <a href="/" title="回到主页"><i class="fa fa-home"></i></a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a href="/2018/11/21/2018flare-on-recording/" title="下一篇: 2018flare-on recording">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/10/08/Flare-On-2019-Writeup/">Flare-On 2019 Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/21/2018flare-on-recording/">2018flare-on recording</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/08/诈尸一下/">诈尸一下</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/06/Ubuntu克隆mac地址后连不上网/">Ubuntu克隆mac地址后连不上网</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/26/FindTheActivity出题记录/">FindTheActivity出题记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/31/编译小米3td内核记录/">编译小米3td内核记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/28/Blog-update-again/">Blog update again...</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/22/源码分析Android-so加载过程/">源码分析Android so加载过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/12/记录一个Windows下Makefile的神坑/">记录一个Windows下Makefile的神坑</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/25/pwnable-kr-思路/">pwnable.kr_思路</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/09/Blog-update/">Blog update!</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/04/About-recently/">About recently</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/11/Android签名原理介绍（2）-schemev2/">Android签名原理介绍（2）--schemev2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/07/Android签名原理介绍（1）--schemev1/">Android签名原理介绍（1）--schemev1</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/21/NGfish_mini-lctf_writeup/">NGfish_mini-lctf_writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/20/pwnhub无用的电脑-丧心病狂-writeup/">pwnhub无用的电脑_丧心病狂_writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/17/各种编码区别及内存映射/">各种编码区别及内存映射</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/28/2016minilctf-Forensics500-Angel-Beats/">2016minilctf-Forensics500-Angel Beats!</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/21/Ubuntu的apache2配置PHP不能运行问题/">Ubuntu的apache2配置PHP不能运行问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/14/数据库坑之记录/">数据库坑之记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/06/汇编学习-nasm使用-调试/">汇编学习&&nasm使用&&调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/11/L-ctf神奇的压缩文件/">2016 L-ctf神奇的压缩文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/23/滴滴-学生卡/">滴滴!!!学生卡</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/11/Android-APP破解-Forest3-6-2/">Android APP破解--Forest3.6.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/29/全国大学生信息安全竞赛初赛-对称密码1/">全国大学生信息安全竞赛初赛_对称密码1</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/26/全国大学生信息安全竞赛初赛_珍贵资料/">全国大学生信息安全竞赛初赛_珍贵资料</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/14/reversing-kr-ImagePic-Write-up/">reversing.kr_ImagePic Write up</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/09/两年了/">两年了</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/07/reversing-kr四道Easy/">reversing.kr四道Easy</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/05/btcf_quals_2014——最难的题目/">btcf_quals_2014——最难的题目</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/30/reversing.kr_replace-Write-up/">reversing.kr_replace Write up</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/29/一篇helloworld及些许说明/">一篇helloworld及些许说明</a></li></ul>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
            }
        })
    </script>



    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2019 giglf
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >dalao到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 8;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-107314179-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?549394a97554b370d120d5a854f98672";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>